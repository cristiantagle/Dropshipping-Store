<!DOCTYPE html>
<html>
<head>
    <title>Debug Carrito</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-info { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .product { background: white; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 3px; }
        button { background: #007cba; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a87; }
    </style>
</head>
<body>
    <h1>üõí Debug del Carrito</h1>
    
    <button onclick="showCartState()">üìä Mostrar Estado del Carrito</button>
    <button onclick="showLogs()">üìã Mostrar Logs Persistentes</button>
    <button onclick="showBackups()">üíæ Mostrar Backups</button>
    <button onclick="clearCart()">üóëÔ∏è Limpiar Carrito</button>
    <button onclick="clearLogs()">üóëÔ∏è Limpiar Logs</button>
    <button onclick="exportCart()">üì• Exportar Carrito</button>
    
    <div id="output"></div>

    <script>
        function showCartState() {
            const output = document.getElementById('output');
            
            try {
                const cartData = localStorage.getItem('carro');
                const items = cartData ? JSON.parse(cartData) : [];
                
                let html = '<div class="debug-info">';
                html += `<h2>üì¶ Estado del Carrito</h2>`;
                html += `<p><strong>Items en localStorage:</strong> ${items.length}</p>`;
                
                if (items.length > 0) {
                    const totalQty = items.reduce((sum, item) => sum + (item.qty || 0), 0);
                    html += `<p><strong>Cantidad total:</strong> ${totalQty}</p>`;
                    html += `<p><strong>Items √∫nicos:</strong> ${items.length}</p>`;
                    
                    html += '<h3>üõçÔ∏è Productos:</h3>';
                    items.forEach((item, index) => {
                        html += `
                            <div class="product">
                                <strong>#${index + 1}</strong><br>
                                <strong>ID:</strong> ${item.id}<br>
                                <strong>Nombre:</strong> ${item.name}<br>
                                <strong>Nombre ES:</strong> ${item.name_es || 'N/A'}<br>
                                <strong>Cantidad:</strong> ${item.qty}<br>
                                <strong>Precio:</strong> $${item.price_cents / 100}<br>
                                <strong>Imagen:</strong> <a href="${item.image_url}" target="_blank">Ver</a>
                            </div>
                        `;
                    });
                } else {
                    html += '<p>‚ùå El carrito est√° vac√≠o</p>';
                }
                
                html += '</div>';
                
                // Tambi√©n mostrar datos raw
                html += '<div class="debug-info">';
                html += '<h3>üîß Datos Raw del localStorage:</h3>';
                html += `<pre>${JSON.stringify(items, null, 2)}</pre>`;
                html += '</div>';
                
                output.innerHTML = html;
                
            } catch (error) {
                output.innerHTML = `<div class="debug-info"><h2>‚ùå Error</h2><p>${error.message}</p></div>`;
            }
        }
        
        function clearCart() {
            localStorage.removeItem('carro');
            localStorage.removeItem('lunaria-cart'); // Por si acaso
            alert('üóëÔ∏è Carrito limpiado');
            showCartState();
        }
        
        function showLogs() {
            const output = document.getElementById('output');
            
            try {
                const logsData = localStorage.getItem('debug-cart-logs');
                const logs = logsData ? JSON.parse(logsData) : [];
                
                let html = '<div class="debug-info">';
                html += `<h2>üìã Logs Persistentes (${logs.length} entradas)</h2>`;
                
                if (logs.length > 0) {
                    html += '<div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fafafa;">';
                    logs.reverse().forEach((log, index) => {
                        const time = new Date(log.timestamp).toLocaleString();
                        const levelColor = log.level === 'error' ? '#d32f2f' : log.level === 'warn' ? '#f57c00' : '#1976d2';
                        html += `
                            <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid ${levelColor}; background: white;">
                                <strong style="color: ${levelColor}">[${log.level.toUpperCase()}]</strong>
                                <small style="float: right; color: #666;">${time}</small><br>
                                <strong>URL:</strong> ${log.url}<br>
                                <strong>Mensaje:</strong> ${log.message}<br>
                                ${Object.keys(log.data).length > 0 ? `<strong>Datos:</strong> <pre style="font-size: 11px; margin: 5px 0;">${JSON.stringify(log.data, null, 2)}</pre>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += '<p>‚ùå No hay logs disponibles</p>';
                }
                
                html += '</div>';
                output.innerHTML = html;
                
            } catch (error) {
                output.innerHTML = `<div class="debug-info"><h2>‚ùå Error</h2><p>${error.message}</p></div>`;
            }
        }
        
        function showBackups() {
            const output = document.getElementById('output');
            
            try {
                const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('carro-backup-')).sort().reverse();
                
                let html = '<div class="debug-info">';
                html += `<h2>üíæ Backups del Carrito (${backupKeys.length} disponibles)</h2>`;
                
                if (backupKeys.length > 0) {
                    backupKeys.forEach((key, index) => {
                        try {
                            const backup = JSON.parse(localStorage.getItem(key));
                            const time = new Date(backup.timestamp).toLocaleString();
                            html += `
                                <div class="product" style="position: relative;">
                                    <strong>Backup #${index + 1}</strong>
                                    <button onclick="restoreBackup('${key}')" style="position: absolute; right: 10px; top: 10px; background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">üîÑ Restaurar</button><br>
                                    <strong>Fecha:</strong> ${time}<br>
                                    <strong>URL:</strong> ${backup.url}<br>
                                    <strong>Items:</strong> ${backup.count} (${backup.items.length} √∫nicos)<br>
                                    <strong>Productos:</strong><br>
                                    <div style="margin-left: 20px; font-size: 12px;">
                                        ${backup.items.map(item => `${item.name} (${item.qty})`).join(', ')}
                                    </div>
                                </div>
                            `;
                        } catch (e) {
                            html += `<div class="product"><strong>Error en backup ${key}:</strong> ${e.message}</div>`;
                        }
                    });
                } else {
                    html += '<p>‚ùå No hay backups disponibles</p>';
                }
                
                html += '</div>';
                output.innerHTML = html;
                
            } catch (error) {
                output.innerHTML = `<div class="debug-info"><h2>‚ùå Error</h2><p>${error.message}</p></div>`;
            }
        }
        
        function restoreBackup(backupKey) {
            try {
                const backup = JSON.parse(localStorage.getItem(backupKey));
                localStorage.setItem('carro', JSON.stringify(backup.items));
                alert(`üîÑ Backup restaurado: ${backup.count} items desde ${new Date(backup.timestamp).toLocaleString()}`);
                showCartState();
                // Disparar evento para que otros componentes se actualicen
                window.dispatchEvent(new CustomEvent('carro:updated', { detail: { items: backup.items, count: backup.count } }));
            } catch (e) {
                alert('‚ùå Error restaurando backup: ' + e.message);
            }
        }
        
        function clearLogs() {
            localStorage.removeItem('debug-cart-logs');
            alert('üóëÔ∏è Logs limpiados');
            showLogs();
        }
        
        function exportCart() {
            const cartData = localStorage.getItem('carro');
            if (cartData) {
                const blob = new Blob([cartData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'carrito-debug.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('üì• Carrito exportado');
            } else {
                alert('‚ùå No hay datos del carrito para exportar');
            }
        }
        
        // Auto-mostrar al cargar
        window.onload = showCartState;
        
        // Escuchar cambios del carrito
        window.addEventListener('storage', showCartState);
        window.addEventListener('carro:updated', showCartState);
    </script>
</body>
</html>